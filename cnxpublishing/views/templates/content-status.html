{% extends "base.html" %}
{% block content %}
  <h1>Conent Status</h1>
  <!-- should js go somewhere else? -->
  <script>
    function returnSubmit(e) {
      if (e.keyCode === 13) filterResults()
    }

    function filterResults() {
      var link = "/a/content-status/?";

      var pageNum = document.getElementById('pageNum').value;
      var numEntries = document.getElementById('numEntries').value;
      if (pageNum != '') link += "page=" + pageNum + "&";
      if (numEntries != '') link += "number=" + numEntries + "&";

      var ident_hash = document.getElementById('ident_hash_filter').value;
      if (ident_hash != '') link += "ident_hash=" + ident_hash + "&";

      var sort_element = document.getElementById('sort_order')
      var sort = sort_element.options[sort_element.selectedIndex].value;
      link += "sort=" + sort + "&";

      var author_filter = document.getElementById('author_filter').value;
      if (author_filter != '') link += "author=" + author_filter + "&";

      var authors = document.getElementById("author_filter")
      for(var i = 0; i < authors.length; i++) {
        if (authors[i].value != '') link += "author" + i + "=" + authors[i].value + "&";
      }

      var statuses = document.getElementsByClassName("status_filter")
      var excluded = []
      for(var i = 0; i < statuses.length; i++) {
        if (! statuses[i].checked) excluded.push(statuses[i].value);
      }
      if (excluded.length > 0) link += "exculde_statuses=" + excluded.join(",")

      window.location.href = link;
    }
  </script>

  Filters:<br>
  Status: <br>
    <label><input type="checkbox" class="status_filter" {{PENDING}} value="PENDING"> PENDING</label>&emsp;&emsp;&emsp;
    <label><input type="checkbox" class="status_filter" {{STARTED}} value="STARTED"> STARTED</label>&emsp;&emsp;&emsp;
    <label><input type="checkbox" class="status_filter" {{RETRY}} value="RETRY"> RETRY</label>&emsp;&emsp;&emsp;
    <label><input type="checkbox" class="status_filter" {{FAILURE}} value="FAILURE"> FAILURE</label>&emsp;&emsp;&emsp;
    <label><input type="checkbox" class="status_filter" {{SUCCESS}} value="SUCCESS"> SUCCESS</label>
  <br><br>Author:
    <textarea rows=1 cols=25 id="author_filter" onkeydown="returnSubmit(event)">{{author}}</textarea><br>
    </div>
  <br>ident_hash:
    <textarea rows=1 cols=50 id="ident_hash_filter" onkeydown="returnSubmit(event)">{{ident_hash}}</textarea><br>
  Entries Per Page:  <textarea rows=1 cols=5 id="numEntries">{{num_entries}}</textarea><br>
  Page:  <textarea rows=1 cols=5 id="pageNum">{{page}}</textarea><br>
  <select id="sort_order">
    <option value="bpsa.created DESC" {{newSort}}>newest first</option>
    <option value="bpsa.created ASC" {{oldSort}}>oldest first</option>
    <option value="STATE" {{stateSort}}>state</option>
    <option value="m.name" {{nameSort}}>title</option>
  </select>
  <br><br>
  <button type="button" onclick="filterResults()">Filter</button><br>
  <br><br><br>

  <table>
    <tr>
      <th>Created</th>
      <th>Ident_hash</th>
      <th>Title</th>
      <th>Author</th>
      <th>State</th>
      <th>Message</th>
    </tr>
    {% for state in states %}
      <tr>
        <td>{{ state.created.strftime('%Y-%m-%d %H:%M:%S') }}</td>
        <td>
          <!-- make this a link to another view page with more info? -->
          <a href="/a/content-status/{{ state.ident_hash }}">{{ state.ident_hash }}</a>
        </td>
        <td>{{ state.title }}</td>
        <td>{{ state.authors }}</td>
        <td>{{ state.state }}</td>
        <td><pre>{{ state.state_message }}</pre></td>
      </tr>
    {% endfor %}
  </table>
{% endblock %}
